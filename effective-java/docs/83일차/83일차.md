# 83일차 2024-07-13 p.449 ~  454

## 12장 직렬화 

이번 장은 객체 직렬화를 다룬다. 객체 직렬화란 자바가 객체를 바이트 스트림으로 인코딩하고 (직렬화) 그 바이트 스트림으로부터 다시 객체를 재구성하는
(역직렬화) 메커니즘이다. 직렬화된 객체는 다른 VM에 전송하거나 디스크에 저장한 후 나중에 역직렬화할 수 있다.


## 아이템 85. 자바 직렬화의 대안을 찾으라

1997년, 자바에 처음으로 직렬화가 도입되었다.

직렬화의 근본적인 문제는 공격 범위가 넓고 지속적으로 더 넓어져 방어하기 어렵다는 점이다
ObjectInputStream 의 readObject 메서드는 클래스 패스 안의 거의 모든 타입의 객체를 만들어 낼 수 있는, 사실상 마법 같은 생성자다.

`코드 85-1 역직렬화 폭탄 - 이 스트림의 역직렬화는 영원히 계속된다.`

```java
    static byte[] bomb() {
        Set<Object> root = new HashSet<>();
        Set<Object> s1 = root;
        Set<Object> s2 = new HashSet<>();
        for (int i=0; i< 100; i++) {
            Set<Object> t1= new HashSet<>();
            Set<Object> t2= new HashSet<>();
            t1.add("foo");
            s1.add(t1);
            s1.add(t2);
            s2.add(t1);
            s2.add(t2);
            s1 = t1;
            s2 = t2;
        }
        return serialize(root);
    }

```
이 객체 그래프는 201개의 HashSet 인스턴스로 구성되며, 그 각각은 3개 이하의 객체 참조를 갖는다. 
스트림의 전체 크기는 5,744 바이트지만, 역직렬화는 태양이 불타 식을 때까지도 끝나지 않을 것이다. 
문제는 HashSet 인스턴스를 역직렬화하려면 그 원소들의 해시코드를 계산해야 한다는 데 있다.
루트 HashSet 에 담기 두 원소는 각각 다른 HashSet 2개 씩을 원소로 갖는 HashSet 이다.

그렇다면 이 문제들을 어떻게 대처해야 할까? 애초에 신뢰할 수 없는 바이트 스트림을 역직렬화하는 일 자체가 스스로를 공격에 노출하는 행위다.
따라서 **직렬화 위험을 회피하는 가장 좋은 방법은 아무것도 역직렬화하지 않는 것이다.**

마찬가지로 **여러분이 작성하는 새로운 시스템에서 자바 직렬화를 써야 할 이유는 전혀 없다.**
객체와 바이트 시퀀스를 변환해주는 다른 메커니즘이 많이 있다.
이 방식들은 자바 직렬화의 여러 위험을 회피하면서 다양한 플랫폼 지원, 우수한 성능 , 풍부한 지원 도구, 활발한 커뮤니티와 전문가 집단 등 수많은 이점까지
제공한다. 이런 메커니즘들도 직렬화 시스템이라 불리기도 하지만, 이 책에서는 자바 직렬화와 구분하고자 크로스-플랫폼 구조화된 데이터 표현이라 한다.


크로스-플랫폼 구조화된 데이터 표현의 선두주자는 JSON 과 프로토콜 버퍼다. 
JSON 은 더글라스-크록퍼드가 브라우저와 서버의 통신용으로 설계했고, 프로토콜 버퍼는 구글이 서버 사이에 데이터를 교환하고 저장하기 위해 설계 했다.

레거시 시스템 때문에 자바 직렬화를 완전히 배제할 수 없을 때의 차선책은 **신뢰할 수 없는 데이터는 절대 역직렬화하지 않는 것이다.**

직렬화를 피할 수 없고 역직렬화 한 데이터가 안전한지 완전히 확신할 수 없다면 객체 역직렬화 필터링 (java.io.ObjectInputFiler) 을 사용하자
객체 역직렬화 필터링은 데이터 스트림이 역직렬화 되기 전에 필터를 설치하는 기능이다.  
클래스 단위로, 특정 클래스를 받아들이거나 거부할 수 있다. '기본 수용' 모드에서는 블랙리스트에 기록된 잠재적으로 위험한 클래스들을 거부한다.
반대로 '기본 거부'모두에서느 화이트리스트에 기록된 안전하다고 알려진 클래스들만 수용한다.

안타깝게도 직렬화는 여전히 자바 생태계 곳곳에 쓰이고 있다. 자바 직렬화를 사용하는 시스템을 관리해야 한다면
시간과 노력을 들여서라도 크로스-플랫폼 구조화된 데이터 표현으로 마이그레이션 하는 것을 심각하게 고민해보길 바란다.
하지만 현실적인 이유로 지금도 직렬화 가능 클래스를 작성하거나 유지보수해야 하는 사람이 있을 수 있다.

> **핵심 정리**
> <br/>
> 직렬화는 위험하니 피해야 한다. 
> 시스템을 밑바닥부터 설계한다면 JSON 이나 프로토콜 버퍼 같은 대안을 사용하자.
> 신뢰할 수 없는 데이터는 역직렬화하지 말자. 꼭 해야 한다면 객체 역직렬화 필터링을 사용하되, 이마저도 모든 공격을 막아줄 수는 없음을 기억하자.
> 클래스가 직렬화를 지원하도록 만들지 말고, 꼭 그렇게 만들어야 한다면 정말 신경 써서 작성해야 한다.


