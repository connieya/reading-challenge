# 27일차 : 2023-10-07 (p.363 ~ 378)

##  GC 튜닝을 항상 할 필요는 없다.

GC 튜닝을 항상 할 필요는 없다. 자바의 GC 튜닝은 꼭 필요한 경우에 하는 것이 좋다.
그렇다면, WAS를 띄울 때 아무런 옵션 없이 띄어도 된다는 말인가? 
그런 말이 절대 아니다. 기본적인 메모리 크기 정도만 지정하면 웬만큼 사용량이 많지 않은
시스템에서는 튜닝을 할 필요가 없다는 말이다.


### GC 튜닝을 꼭 해야 할까?

Java 기반의 모든 서비스에서 GC 튜닝을 진행할 필요는 없다.
GC 튜닝이 필요 없다는 이야기는 운영 중인 Java 기반 시스템의 옵션에 기본적으로 다음과
같은 것들이 추가되어 있을 때의 경우다.

- -Xms 옵션과 -Xmx 옵션으로 메모리 크기를 지정했다.
- -server 옵션이 포함되어 있다.

그리고 시스템의 로그에는 타임아웃 관련 로그가 남아있지 않아야 한다. 
여기서 타임아웃은 다음과 같은 것들을 말한다.

- DB 작업과 관련된 타임아웃
- 다른 서버와의 통신시 타임아웃

타임아웃 로그가 존재하고 있다는 것은 그 시스템을 사용하는 사용자 중 대다수나 일부는 
정상적인 응답을 받지 못했다는 말이다. 그리고, 대부분 서로 다른 서버 간에 통신 문제나
원격 서버의 성능이 느려서 타임아웃이 발생할 수도 있지만, 그 이유가 GC 때문일 수도 있다.

지금까지 이야기 한 것을 정리하자면,

- JVM 의 메모리 크기도 지정하지 않았고,
- Timeout이 지속적으로 발생하고 있다면

시스템에서 GC 튜닝을 하는 것이 좋다. 그렇지 않다면, GC 튜닝할 시간에 다른 작업을 
하는 것이 더 낫다.

그런데 한 가지 꼭 명심해야 하는 점이 있다. GC 튜닝은 가장 마지막에 하는 작업이라는 것이다.

GC 튜닝을 왜 하는지 근본적인 이유를 생각해 보자. Java 에서 생성된 객체는 
가비지 컬렉터가 처리해서 지운다. 생성된 객체가 많으면 많을 수록 가비지 컬렉터가 처리해야
하는 대상도 많아지고, GC를 수행하는 횟수도 증가한다. 운영하고 만드는 시스템이 GC를 
적게 하도록 하려면 객체 생성을 줄이는 작업을 먼저 해야 한다.

티끌 모아 태산이라는 말이 있듯이, 
String 대신 StringBuilder 나 StringBuffer 를 사용하는 거나, 로그를 최대한
적게 쌓도록 하는 등 임시 메모리를 적게 사용하도록 하는 작업이 중요하다.

만약 애플리케이션 메모리 사용도 튜닝을 많이 해서 어느 정도 만족할 만한 상황이 되었다면,
본격적으로 GC 튜닝을 시작하면 된다. 필자는 GC 튜닝의 목적을 두 가지로 나눈다.
Old 영역으로 넘어가는 객체의 수를 최소화하는 것과 Full GC의 실행 시간을 줄이는 것이다.

#### Old 영역으로 넘어가는 객체의 수 최소화하기

Oracle JVM에서 제공하는 모든 GC는 Generational GC 이다. 즉 , Eden 영역에서
객체가 처음 만들어지고, Survivor 영역을 오가다가, 끝까지 남아 있는 객체는 
Old 영역으로 이동한다. 간혹 Eden 영역에서 만들어지다가 크기가 커져서 Old 영역으로 바로
넘어가는 객체도 있긴 하다. Old 영역의 GC는 New 영역의 GC에 비하여
상대적으로 시간이 오래 소요되기 때문에 Old 영역으로 이동하는 객체의 수를 줄이면
Full GC가 발생하는 빈도를 많이 줄일 수 있다. Old 영역으로 넘어가는 객체의 수를 줄인다는
말을 잘못 이해하면 객체를 마음대로 New 영역에만 남길 수 있다고 생각할 수 있지만,
그렇게는 할 수는 없다. 하지만 New 영역의 크기를 잘 조절함으로써 큰 효과를 볼 수는 있다.

#### Full GC 시간 줄이기 

Full GC의 수행 시간은 상대적으로 Young GC에 비하여 길다. 그래서 Full GC 실행에 
시간이 오래 소요되면 연계된 여러 부분에서 타임아웃이 발생할 수 있다. 
그렇다고 Full GC 실행 시간을 줄이기 위해서 Old 영역의 크기를 줄이면 
OutOfMemoryError 가 발생하거나 Full GC 횟수가 늘어난다. 
반대로 Old 영역의 크기를 늘리면 Full GC 횟수는 줄어들지만 실행 시간이 늘어난다.
Old 영역의 크기를 적절하게 '잘' 설정해야 한다.

## GC 튜닝의 절차

GC를 튜닝하는 절차는 대부분의 성능 개선 작업과 크게 다르지 않다. 
다음은 필자가 사용하는 GC 튜닝 절차이다.

- GC 상황 모니터링
  - GC 상황을 모니터링하면 현재 운영되는 시스템의 GC 상황을 확인해야 한다. 
- 모니터링 결과 분석 후 GC 튜닝 여부 결정
  - GC 상황을 확인한 후에는, 결과를 분석하고 GC 튜닝 여부를 결정해야 한다.
  - 분석한 결과를 확인했는데 GC 수행에 소요된 시간이 0.1~0.3초 밖에 안 된다면 굳이 GC 튜닝에 시간을 낭비할 필요는 없다.
  - 하지만 GC 수행 시간이 1~3초, 심지어 10초가 넘는 상황이라면 GC 튜닝을 진행해야 한다. 
- GC 방식/메모리 크기 지정
  - GC 튜닝을 진행하기로 결정했다면 GC 방식을 선정하고 메모리의 크기를 지정한다. 
  - 이때 서버가 여러 대이면 서버에 GC 옵션을 서로 다르게 지정해서 GC 옵션에 따른 차이를 확인하는 것이 중요하다.
- 결과 분석
  - GC 옵션을 지정하고 적어도 24시간 이상 데이터를 수집한 후에 분석을 실시한다.
  - 운이 좋으면 해당 시스템에 적합한 GC 옵션을 찾을 수 있다.
- 결과가 만족스러울 경우 전체 서버에 반영 및 종료
  - GC 튜닝 결과가 만족스러우면 전체 서버에 GC 옵션을 적용하고 마무리한다. 
  - 그런데, 이 작업은 매우 조심해서 접근해야 한다. 잘못하면 장애로 이어질수도 있기 때문이다.