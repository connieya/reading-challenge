# 29일차 : 2023-10-11 (p.461 ~469 )

## Cache의 활용

### Cache is not a silver bullet!

Cache를 사용하면 성능을 크게 높일 수 있지만, 무분별하게 캐시를 사용하면 안된다.

캐시를 시스템 상으로 분류하면,

- CPU L1 Cache
- CPU L2 Cache
- Disk Cache

등이 있는데, 이 캐시들은 OS 및 하드웨어에서 제공하는 캐시를 말한다. 
즉, 시스템의 성능을 높이는 데 사용되는 것들이다.

지금 정리하는 캐시는 이 레벨의 캐시가 아니다.


서비스를 개발하는 개발자들의 기분으로 보는 캐시는 다음과 같이 아주 간단하게 분류할 수도 있다.

- 로컬 캐시
- 글로벌 캐시

여기서 로컬 캐시는 하나의 장비나 JVM 내에서 캐시 내용이 공유되는 것을 말한다.
다시 말해서, 서로 다른 장비에 있는 데이터를 사용하기 위한 통신비용이 들지 않는 캐시를 말한다.
그리고, 글로벌 캐시는 다른 장비에 있는 캐시의 내용을 공유하는 것을 말한다. 

|구분|장점|단점|
|---|-----|---|
|로컬 캐시| 같은 JVM내 혹은 같은 장비에서 데이터를 가져오므로 성능이 좋다. | 하나의 장비 내에 있는 데이터만 동기화가 이루어진다.
|글로벌 캐시 | 데이터 동기화가 실시간으로 이루어지기 때문에 모든 사용자가 동일한 데이터를 가질 수 있다. | 성능이 로컬 캐시에 비해 좋지 않다.|


캐시 종류

|이름 | 개발사| 주 개발 언어 | 저장 방식|
|-----|------|-------|------|
|EHCache | TerraCotta| 자바| Key - Value|
|Memcached | 오픈 소스 | C | Key-Value|
|Redis | 오픈 소스 | C | Key-Value|
|MongoDB | 오픈 소스 | C++ | Key-Value 및 JSON 기반 |
|HBase | 오픈소스 | 자바 | Tabular (테이블 기반)

여기서 Key-Value 기반의 저장 방식은 Hashtable 과 같이 키 와 값으로 된 저장 방식을 말한다.
MongoDB 의 경우는 JSON 데이터가 저장되는 방식이다.

따라서, 지금까지의 관계형 DBMS가 고정되어 있는 형태의 저장소라면,
MongoDB는 유연한 형태의 저장소라고 볼 수 있다. 


### 캐시의 선택

NoSQL 기반의 캐시를 사용할 때는 BMT(Benchmark Test)를 통해서 
현재 개발하려는 시스템의 상황에 맞게 가장 잘 맞는 캐시를 선정해야 한다.

캐시가 들어가는 데이터의 크기가 500MB 정도라면 확장성이 큰 문제가 되지 않을 것이다.
하지만, 300GB 정도의 데이터가 들어간다면 어떻게 할까?
캐시는 자주 사용하는 필요한 대부분의 내용을 메모리에만 담는 경우도 있고, 
메모리와 디스크와 같은 물리 저장소에 같이 저장하는 경우도 있다. 
그런데, 이렇게 디스크에 젖아하는 경우 성능이 아주 좋은 SSD가 아닌 이상 읽고 쓰는 성능은 
매우 느려진다. 서버의 성능을 높이기 위해서 사용하는 캐시가 오히려 성능을 저하시킬 수도 있다는
이야기다. 그래서, 많은 경우에 300GB 정도의 데이터를 저장하려면 여러 서버에
분산하여 데이터를 저장하는 방식을 취한다. 

그런데, 모든 캐시가 분산 환경을 제공하는 것은 아니다. Memcached 에서 제공하는 기본 기능은
단독 서버에서 데이터를 제공하는 방식이며, 디스크 저장을 하지 않고 메모리에 저장한다.
따라서 서버에 비싼 메모리 300GB를 꽂는다면 엄청난 비용이 들게 될 것이다.


캐시는 날아가도 상관 없는 데이터를 처리하는데 사용하는 것이 좋다.

예를 들어,

- 1분에 몇 번 로그인하는지 확인하고자 할 때
- 카페 등에서 최근에 쓴 글이 어떤글인지 확인하고자 할 때
- CPU 사용량등과 같이 수집되는 데이터가 10만개 중 한두개 없어져도 전혀 문제 안되는 작업을 할 때

등 어떻게 보면 1분 뒤에 날아가도 되는 데이터나 RDBMS에서 데이터를 가져와도 되지만
매우 자주 사용되면서 캐시에 없으면 DB에서 가져오면 되는 것들에 적용하면 큰 효과를 볼 수 있다.

### Key-Value Cache 

Key-Value 캐시는 Hashtable 과 같은 Map 굴조라고 생각하면 된다. 
하지만 이러한 Key-Value 캐시 내부는 단순하게 되어 있지 않다. 
그중 Memcached 는 메모리 기반의 캐시다. 다시 말해서, 캐시 프로세스가 종료되면
캐시 내부에 있는 데이터는 모두 사라진다. 따라서 이런 단점을 보완하기 위해서
Tokyo Cabinet 와 같이 파일에 데이터를 저장할 수 있는 캐시도 나타났다. 

캐시는 보통 여러 언에서 사용할 수 있다.
다양한 언어에서 사용할 수 있는 각종 클라이언트용 API 들이 존재한다. 

구글에서 'memcached client' 처럼 캐시 이름을 적고 뒤에 client 만 적어주면 사용 가능한
언어별로 정리가 잘 되어 있는 페이지를 만날 수 있다.

자바를 사용할 경우 spymemcached 라는 것이 가장 대표적인 라이브러리다.

