# 20일차 : 2023-09-30 (p.269 ~  276)

## DB Connection Pool 및 스레드 개수 설정

DB Connection Pool 과 스레드 개수는 메모리와 관련이 있다. 
많이 사용할수록 메모리를 많이 점유하게 된다. 
그렇다고 메모리를 위해서 DB Connection Pool 과 스레드 개수를 적게 지정하면, 
서버에서는 많은 요청을 처리하지 못하고 대기할 수 밖에 없다.

대부분의 WAS에서는 DB Connection Pool 의 개수를 최소치 , 증가치, 최대치 등으로 자세하게
지정할 수 있다. 최소치는 말 그대로 서버가 기동될 때 연결을 수행하는 개수이다. 
개발자용 PC에서는 이 값이 높을 필요가 없으므로 이 값은 최소한으로 지정하자.

최소 개수가 많으면 많을수록 서버 기동하는 시간이 오래 소요되므로, 개발자가 디버그를
하기 위해서 여러 번 재기동을 할 때는 좋지 않다. 하지만 운영 중에는
최소 및 최대 값을 동일하게 하는 것이 좋다. 사용자 수가 갑자기 증가하면 DB Connection Pool의
개수도 증가되어야 하고, 증가할 때 대기 시간이 발생할 확률이 크기 때문이다. 만약 DB 서버의 
리소스가 부족하다면 최소 값을 적게 해놓는 것도 한 방법이 될 수 있다.

DB Connection Pool의 개수를 기준으로 적절한 수치를 찾는 방법을 생각해 보자.
DB Connection Pool을 40개로 잡아 놓았다고 가정하자. 40개 전부를 사용하면서 DB의
CPU 사용량이 100%에 도달했다면, 어떻게 해야할까? 이 경우에는 DB의 CPU를 점유하는
쿼리를 찾아서 튜닝을 수행해야 한다.  다시 말하면, 인덱스가 없거나 테이블을 풀 스캔하는 
쿼리가 있는 것은 아닌지 쿼리의 플랜을 떠서 확인해 봐야 한다. 40개를 전부 사용한다고 해서
DB Connection Pool 개수를 80~200개로 늘리면, 모든 DB와의 연결을 전부 사용하고 
응답 시간은 엄청나게 느려질 뿐이다.

이번에는 DB의 CPU 사용량은 50%도 되지 않는 상황에서 WAS의 CPU 사용량이 100%에 
도달하고 있는 상황을 생각해 보자. 그때 사용하는 DB Connection Pool의 개수는
20개 정도 밖에 되지 않는다. 이럴 때는 어떻게 해야할까? 이 경우에는 WAS의 애플리케이션을
튜닝해야 한다. 하지만 이미 튜닝 된 상태라면 이 서버의 DB Connection Pool의 개수는
약간의 여유를 두기 위해서 25~30개 정도로 지정하는 것이 좋다. 

Conneciton Pool의 개수만큼 중요한 값이 있다. 바로 대기 시간과 관련된 값이다. 
MyBatis와 같이 DB와 자바 프로그램을 매핑해주는 프레임워크에는 각종 설정 값들이 있는데,
이 값 중에서 대기 시간을 나타내는 wait time과 관련된 값들이 존재한다.

왜 이 값이 중요할까? 앞서 이야기 한대로 DB Connection Pool의 개수를 넘어 섰을 때
애플리케이션에서는 '어디 남는 Connection 없나?' 하고 두리번거리면서 기다린다. 
그런데, 이 기다리는 시간이 바로 대기 시간이다. MyBatis 에서는 poolTimeToWait 라는
값으로 이 대기 시간을 결정하며, 기본은 20초다. 다시 말해서 이 값을 
그냥 놔 둘 경우 DB 연결을 못해 기다리는 사용자들이 적어도 20초는 대기해야 한다는 말이다.

그렇다고 대기 시간을 아주 짧게 주면 어떻게 될까? 예를 들어 100ms 정도로 줄 경우에는
문제가 없을까? 메모리를 1GB 로 할당한 WAS에서 300ms 이하의 Full GC시간을 만들기는 매우 어렵다.
만약 DB 연결을 하려고 대기하는 순간 Full GC가 발생하면 그 순간에 대기하고 있는
모든 스레드는 DB와 연결을 못했다고 Timeout을 내뿜을 수도 있다. 


